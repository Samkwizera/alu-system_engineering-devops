#!/usr/bin/env bash
# Script to configure Nginx with custom HTTP response header X-Served-By

# Exit on any error
set -e

# Update package list and install Nginx
apt-get update -y
apt-get install nginx -y

# Get the hostname of the server
HOSTNAME=$(hostname)

# Configure Nginx with custom header
NGINX_CONFIG="/etc/nginx/sites-available/default"

# Backup original config
cp "$NGINX_CONFIG" "${NGINX_CONFIG}.bak"

# Add custom header to Nginx configuration
sed -i "/server_name _;/a \    add_header X-Served-By $HOSTNAME;" "$NGINX_CONFIG"

# Test Nginx configuration
if ! nginx -t; then
    echo "Nginx configuration test failed"
    exit 1
fi

# Restart Nginx to apply changes
service nginx restart

# Ensure Nginx is enabled
systemctl enable nginx

# Verify the header is working
sleep 2  # Give Nginx time to restart
if curl -sI localhost | grep -q "X-Served-By: $HOSTNAME"; then
    echo "Configuration successful"
    exit 0
else
    echo "Header verification failed"
    exit 1
fi
